{% load like_tags %}
{% load thumbnail %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Feed</title>
    
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />

    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />

    <style>
        /* --- ORIGINAL POST CARD STYLING --- */
        .post-card {
            display: flex;
            flex-direction: column;
            border: none;
            border-radius: 12px ;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #ffffff;
        }

        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
        }

        .card-header-custom {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            padding-bottom: 0.75rem;
            background: none;
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #e0e0e0;
        }

        .user-details strong {
            font-size: 1.1rem;
            line-height: 1.2;
        }

        .user-details small {
            display: block;
            color: #6c757d;
            margin-top: 2px;
        }

        .post-title {
            margin-bottom: 0.5rem;
        }

        .description-wrapper {
            padding: 0 1.25rem 1rem 1.25rem;
        }

        .description-text {
            overflow: hidden;
            position: relative;
            color: #343a40;
            font-size: 1rem;
            line-height: 1.5;
        }

        .description-text.compact {
            max-height: 4.5rem;
        }

        .read-more-btn {
            background: none;
            border: none;
            padding: 0;
            margin-left: 5px;
            font-weight: bold;
            color: #0d6efd;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        .post-image {
            width: 100%;
            height: auto;
            max-height: 550px;
            object-fit: cover;
            display: block;
        }

        .likes-count {
            padding: 0.5rem 1.25rem 0.25rem 1.25rem;
            border-top: 1px solid #f0f0f0;
        }
        
        .card-actions {
            display: flex;
            justify-content: space-around;
            padding: 5px 0;
            border-top: 1px solid #f0f0f0;
        }

        .action-button, .like-button-content {
            flex-grow: 1;
            text-align: center;
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-weight: 500;
            padding: 8px 10px;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .action-button:hover, .like-button-content:hover {
            background-color: #f8f9fa;
            color: #0d6efd;
        }

        .like-form {
            flex-grow: 1;
            border-right: 1px solid #f0f0f0;
        }

        /* --- NEW STYLES FOR INLINE COMMENT BOX --- */
        .inline-comment-container {
            /* Hidden by default, shown by JS */
            display: none; 
            margin-top: 10px;
            padding: 15px;
            background-color: #fcfcfc;
            border: 1px solid #eee;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease-in-out;
        }

        /* Loading indicator styling */
        .loading-comment-box {
            text-align: center;
            padding: 20px 0;
            color: #6c757d;
        }
    </style>
</head>
<body>

<script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    defer
></script>

<div class="container my-5">
    <div class="row justify-content-center">

    {% for post in posts %}
        <div class="col-12 col-md-9 col-lg-7 mb-4">
            <div class="card post-card shadow-sm" id="post-card-{{ post.pk }}">

                <div class="card-header-custom">
                    <div class="user-info">
                        {% if post.created_by.profile_pic %}
                        <img src="{% thumbnail post.created_by.profile_pic 48x48 crop="center" quality=90 %}" class="user-avatar" alt="{{ post.created_by.first_name }}'s profile pic" />
                        {% else %}
                        <img src="/media/accounts/profile/no_profile.jpg" class="user-avatar" alt="No profile pic" />
                        {% endif %}

                        <div class="user-details">
                            <strong><a href="{% url "profile" post.created_by.username %}" class="text-decoration-none text-dark">{{ post.created_by.first_name }} {{ post.created_by.last_name }}</a></strong>
                            <small class="text-muted">{{ post.created_at|date:"M d, Y h:i A" }}</small>
                        </div>
                    </div>
                    
                    <div class="dropdown">
                        <button class="btn btn-sm text-secondary" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            {% if request.user == post.created_by %}
                            <li>
                                <a class="dropdown-item" href="{% url 'post_edit' post.pk %}">
                                    <i class="bi bi-pencil-square me-2"></i>Edit Post
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item text-danger" href="{% url 'post_delete' post.pk %}">
                                    <i class="bi bi-trash me-2"></i>Delete Post
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            {% endif %}
                            <li>
                                <a class="dropdown-item" href="#">
                                    <i class="bi bi-flag me-2"></i>Report Post
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="description-wrapper">
                    <h5 class="post-title fw-bold">{{ post.title }}</h5>
                    
                    <div class="description-container" id="desc-container-{{ post.pk }}">
                        <p class="description-text compact mb-0" id="desc-text-{{ post.pk }}">
                            {{ post.description }}
                        </p>
                        
                        <button 
                            class="read-more-btn" 
                            id="read-more-{{ post.pk }}" 
                            data-target="#desc-text-{{ post.pk }}"
                            data-container="#desc-container-{{ post.pk }}"
                            onclick="toggleDescription('{{ post.pk }}')">
                            ...Read More
                        </button>
                    </div>
                </div>

                {% if post.image %}
                <a href="{{post.image.url}}" class="post-image-link">
                    <img 
                        src="{% thumbnail post.image 400x300 crop="smart" quality=95 %}" 
                        class="img-fluid post-image" 
                        alt="{{post.title}}" 
                    />
                </a>
                {% endif %}

                <div class="likes-count">
                    <small class="text-muted fw-bold" id="like-count-{{post.id}}">{{ post.likes_count }} Likes</small>
                </div>

                <div class="card-actions">
                    <button 
                        type="button" 
                        class="like-button-content {% if post.is_liked_by_user %}text-primary{% endif %}"
                        id="like-btn-{{ post.id }}"
                        data-post-id="{{ post.id }}"
                        data-action="{% if post.is_liked_by_user %}unlike{% else %}like{% endif %}"
                        data-url="{% url 'like_action' %}"
                        onclick="toggleLike(this)">
                        
                        <i class="bi {% if post.is_liked_by_user %}bi-hand-thumbs-up-fill{% else %}bi-hand-thumbs-up{% endif %}" 
                           id="like-icon-{{ post.id }}"></i> 
                        
                        <span id="like-text-{{ post.id }}">
                            {% if post.is_liked_by_user %}Unlike{% else %}Like{% endif %}
                        </span>
                    </button>

                    <button 
                        type="button" 
                        class="action-button border-end" 
                        data-post-id="{{ post.pk }}"
                        onclick="toggleInlineComment(this, '{% url "add_comment" post.id %}')">
                        <i class="bi bi-chat-left-text"></i> Comment
                    </button>
                    
                    <button type="button" class="action-button">
                        <i class="bi bi-share"></i> Share
                    </button>
                </div>
            </div>

            <div class="inline-comment-container" id="comment-container-{{ post.pk }}">
                </div>
        </div>
    {% endfor %}

    </div>
</div>

<script>
    // --- CSRF Helper Function (Required for Django POST requests) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- AJAX LIKE/UNLIKE FUNCTION ---
    function toggleLike(button) {
        // Get data from the button's attributes
        const postId = button.getAttribute('data-post-id');
        const action = button.getAttribute('data-action'); // 'like' or 'unlike'
        const url = button.getAttribute('data-url');
        
        // Find UI elements to update using unique IDs
        const countElement = document.getElementById(`like-count-${postId}`);
        const iconElement = document.getElementById(`like-icon-${postId}`);
        const textElement = document.getElementById(`like-text-${postId}`);

        // Prepare Form Data - Sending 'id' in the body
        const formData = new FormData();
        formData.append('id', postId); // <--- POST ID is sent here!
        formData.append('action', action); 

        // Perform the AJAX request
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' ,
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            // Data expected from the Django view: { "success": true, "likes_count": 55 }
            if (data.success) {
                const isLiking = (action === 'like');
                
                // 1. Update the Like Count
                if (countElement) {
                    countElement.innerText = `${data.likes_count} Likes`;
                }

                // 2. Update the Button State (Icon, Text, Color, and data-action)
                if (isLiking) {
                    // Successful 'like' -> change button state to 'unlike'
                    button.setAttribute('data-action', 'unlike');
                    button.classList.add('text-primary'); 
                    iconElement.classList.remove('bi-hand-thumbs-up');
                    iconElement.classList.add('bi-hand-thumbs-up-fill');
                    textElement.innerText = 'Unlike';
                } else {
                    // Successful 'unlike' -> change button state to 'like'
                    button.setAttribute('data-action', 'like');
                    button.classList.remove('text-primary'); 
                    iconElement.classList.remove('bi-hand-thumbs-up-fill');
                    iconElement.classList.add('bi-hand-thumbs-up');
                    textElement.innerText = 'Like';
                }
            } else {
                console.error("AJAX failed but returned success: false or invalid status.");
            }
        })
        .catch(error => {
            console.error('Fetch error during like action:', error);
            alert('An error occurred while processing your request.');
        });
    }

    // --- Existing Read More/Less Functions ---
    function toggleDescription(postId) {
        const descText = document.getElementById(`desc-text-${postId}`);
        const readMoreBtn = document.getElementById(`read-more-${postId}`);
        
        if (descText.classList.contains('compact')) {
            descText.classList.remove('compact');
            readMoreBtn.textContent = ' Show Less';
        } else {
            descText.classList.add('compact');
            readMoreBtn.textContent = '...Read More';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.description-text').forEach(descText => {
            const clone = descText.cloneNode(true);
            clone.classList.remove('compact');
            clone.style.position = 'absolute';
            clone.style.visibility = 'hidden';
            clone.style.height = 'auto';
            
            descText.parentNode.appendChild(clone);
            const fullHeight = clone.offsetHeight;
            const compactHeight = descText.offsetHeight; 
            
            descText.parentNode.removeChild(clone);

            const postId = descText.id.split('-')[2];
            const readMoreBtn = document.getElementById(`read-more-${postId}`);

            if (fullHeight <= compactHeight + 5) { 
                readMoreBtn.style.display = 'none';
                descText.classList.remove('compact');
            }
        });
    });

    // --- Existing Inline Comment Toggle Function ---
    function toggleInlineComment(element, commentUrl) {
        const postId = element.getAttribute('data-post-id');
        const commentContainer = document.getElementById(`comment-container-${postId}`);
        
        if (commentContainer.style.display === 'block') {
            commentContainer.style.display = 'none';
            commentContainer.innerHTML = ''; 
            return;
        }

        document.querySelectorAll('.inline-comment-container').forEach(otherContainer => {
            if (otherContainer.id !== `comment-container-${postId}`) {
                otherContainer.style.display = 'none';
                otherContainer.innerHTML = ''; 
            }
        });

        commentContainer.style.display = 'block';
        commentContainer.innerHTML = `
            <div class="loading-comment-box">
                <i class="bi bi-arrow-clockwise spin me-2"></i> Loading Comments...
            </div>
        `;
        
        const style = document.createElement('style');
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .spin { animation: spin 2s linear infinite; }';
        document.head.appendChild(style);

        fetch(commentUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load comment box.');
                }
                return response.text(); 
            })
            .then(html => {
                commentContainer.innerHTML = html;
                document.head.removeChild(style);
                commentContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            })
            .catch(error => {
                console.error('Error loading comment box:', error);
                commentContainer.innerHTML = `<p class="alert alert-danger mb-0">Error loading comments.</p>`;
                document.head.removeChild(style);
            });
    }
</script>

</body>
</html>